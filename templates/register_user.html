{% extends "base.html" %}
{% block content %}
<h5 class="card-title fw-semibold mb-4">Register</h5>
<!-- Begin form for adding an entity -->
<div class="card">
  <div class="card-body">
    <form id="addEntityForm" method="post" action="{% url 'register_roles' %}" class="registration-form">
      {% csrf_token %}

      <div class="mb-3">
        <label for="id_entity_type" class="form-label">Entity Type</label>
        <select name="entity_type" class="form-control" id="id_entity_type">
          {% for value, label in form.fields.entity_type.choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label for="id_address" class="form-label">Address</label>
        <input type="text" name="address" class="form-control" id="id_address" maxlength="100">
      </div>
      <div class="mb-3">
        <label for="id_name" class="form-label">Name</label>
        <input type="text" name="name" class="form-control" id="id_name" maxlength="100">
      </div>
      <div class="mb-3">
        <label for="id_place" class="form-label">Place</label>
        <input type="text" name="place" class="form-control" id="id_place" maxlength="100">
      </div>
      <button type="submit" class="ethereumButton btn btn-primary">Submit</button>
    </form>
  </div>
</div>
<br />
<div class="alert alert-success" role="alert" style="display:none;" id="successAlert">
  You have successfully registered!
</div>
<h5 class="card-title fw-semibold mb-4">Raw Material Suppliers</h5>
<div class="table-responsive">
  <table class="table text-nowrap mb-0 align-middle">
    <thead class="text-dark fs-4">
    <tr>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">ID</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Name</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Place</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Ethereum Address</h6></th>
    </tr>
    </thead>
    <tbody>
    {% for rm in rms.values %}
    <tr>
      <td class="border-bottom-0"><h6 class="fw-semibold mb-0">{{ rm.1 }}</h6></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ rm.2 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ rm.3 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ rm.0 }}</p></td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<h5 class="card-title fw-semibold mb-4">Manufacturers</h5>
<div class="table-responsive">
  <table class="table text-nowrap mb-0 align-middle">
    <thead class="text-dark fs-4">
    <tr>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">ID</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Name</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Place</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Ethereum Address</h6></th>
    </tr>
    </thead>
    <tbody>
    {% for ma in man.values %}
    <tr>
      <td class="border-bottom-0"><h6 class="fw-semibold mb-0">{{ ma.1 }}</h6></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ ma.2 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ ma.3 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ ma.0 }}</p></td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<h5 class="card-title fw-semibold mb-4">Distributors</h5>
<div class="table-responsive">
  <table class="table text-nowrap mb-0 align-middle">
    <thead class="text-dark fs-4">
    <tr>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">ID</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Name</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Place</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Ethereum Address</h6></th>
    </tr>
    </thead>
    <tbody>
    {% for di in dis.values %}
    <tr>
      <td class="border-bottom-0"><h6 class="fw-semibold mb-0">{{ di.1 }}</h6></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ di.2 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ di.3 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ di.0 }}</p></td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<h5 class="card-title fw-semibold mb-4">Retailers</h5>
<div class="table-responsive">
  <table class="table text-nowrap mb-0 align-middle">
    <thead class="text-dark fs-4">
    <tr>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">ID</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Name</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Place</h6></th>
      <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Ethereum Address</h6></th>
    </tr>
    </thead>
    <tbody>
    {% for re in ret.values %}
    <tr>
      <td class="border-bottom-0"><h6 class="fw-semibold mb-0">{{ re.1 }}</h6></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ re.2 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ re.3 }}</p></td>
      <td class="border-bottom-0"><p class="mb-0 fw-normal">{{ re.0 }}</p></td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>




<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
<script>
  const contractABI = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "DIS",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Distribute",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "MAN",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Manufacturing",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "Owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "ProductStock",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "description",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "RMSid",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "MANid",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "DISid",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "RETid",
          "type": "uint256"
        },
        {
          "internalType": "enum TextileSupplyChain.STAGE",
          "name": "stage",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "RET",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "RMS",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "RMSsupply",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Retail",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Sold",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addDistributor",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addManufacturer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addRMS",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addRetailer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_description",
          "type": "string"
        }
      ],
      "name": "addproduct",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "disCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "manCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "productCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "retCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "rmsCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "showStage",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]
  document.querySelector('.ethereumButton').addEventListener('click', function (e) {
    e.preventDefault(); // Prevent form from submitting immediately

    if (!window.ethereum) {
      alert('MetaMask is not installed!');
      return;
    }

    const web3 = new Web3(window.ethereum);
    const contractAddress = '0xFE8dd0108F2120998b31F236F1435D090C1f3d1c';
    const contract = new web3.eth.Contract(contractABI, contractAddress);
    const entityType = document.getElementById('id_entity_type').value;
    const address = document.getElementById('id_address').value;
    const name = document.getElementById('id_name').value;
    const place = document.getElementById('id_place').value;
    const methodMapping = {
      'M': 'addManufacturer',
      'D': 'addDistributor',
      'R': 'addRetailer',
      'S': 'addRMS',
    };
    const methodName = methodMapping[entityType];

    window.ethereum.request({ method: 'eth_requestAccounts' })
      .then(accounts => {
        const account = accounts[0];
        const tx = contract.methods[methodName](address, name, place);
        return tx.send({ from: account });
      })
      .then(result => {
        document.getElementById('successAlert').style.display = 'block';
        // Submit form data
        let formData = new FormData(document.getElementById('addEntityForm'));
        fetch('{% url "register_roles" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        }).then(response => {
          if (response.ok) {
            console.log("Server received the form data successfully.");
            // Handle redirection or display success message here
          } else {
            console.error("Server responded with status:", response.status);
          }
        });
      })
      .catch(error => {
        console.error("An error occurred:", error);
        // Display the error to the user
        alert("An error occurred. Please try again.");
      });
  });
</script>
{% endblock content %}