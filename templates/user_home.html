{% extends 'base user.html' %}
{% load static %}
{% load user_filters %}

{% block heading %} <div class="username" id="usernameDisplay"></div>{% endblock heading %}
{% block something %}{% endblock something %}

{% block content %}

<h5 class="card-title fw-semibold mb-4" id="currentAccount">Welcome, </h5>
<div class="container-fluid">
    <div class="container-fluid">
      <div class="card">
        <div class="card-body">
          <div class="row">
            {% if user.user_type in "Supplier,Manufacturer,Distributor" %}
            <div class="col-md-4">
              <div class="card">
                <img src="{% static 'images/products/s1.jpg' %}" class="card-img-top" alt="...">
                <div class="card-body">
                  <h5 class="card-title">Order Management</h5>
                  <p class="card-text">Manage your incoming and outgoing orders.</p>
                  <a href="#" class="btn btn-primary">Manage Orders</a>
                </div>
              </div>
            </div>
            {% endif %}
            
            <div class="col-md-4">
              <h5 class="card-title fw-semibold mb-4">Manage Orders</h5>
              <div class="card">
                <div class="card-header">
                  Featured
                </div>
                <div class="card-body">
                  <h5 class="card-title">Get your orders</h5>
                  <h6 class="card-subtitle mb-2 text-muted"></h6>
                  <p class="card-text">These are the products that you have processed</p>
                  <a href="{% url 'manage' %}" class="card-link">View orders</a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <h5 class="card-title fw-semibold mb-4">Messaging</h5>
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Chat with Admin or other users</h5>
                  <p class="card-text">Update admin on the status of the product</p>
                  <p class="card-text">Request other users to process</p>
                  <a href="{% url 'chatuser' %}" class="btn btn-primary">Go to chat</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  
<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>

<script>
  async function loadABI() {
      const response = await fetch('./contracts/myContractABI.json');
      const abi = await response.json();
      console.log("ABI loaded:", abi);
  }

  let contract;
  const web3 = new Web3(window.ethereum);
  let currentAccount = null;

  async function initWeb3() {
  if (window.ethereum) {
      window.web3 = new Web3(window.ethereum);
      console.log("Web3 initialized.");
      try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          console.log("Accounts requested.");
          const accounts = await web3.eth.getAccounts();
          console.log("Accounts retrieved:", accounts);
          if (accounts.length > 0) {
              currentAccount = accounts[0];
              console.log("Current Account:", currentAccount);
              document.getElementById('currentAccount').innerText = `${currentAccount}`;
              contract = new web3.eth.Contract(contractABI, '0x2fbd267BFF038d2FdeDCb65bcd54e049E4199103');
              console.log("Contract initialized:", contract);
              getUserName();
          } else {
              console.error("No accounts found.");
          }
      } catch (error) {
          console.error("Could not get accounts", error);
      }
  } else {
      console.error("Ethereum object not found. Make sure you have a web3 provider.");
  }
}
async function getUserName() {
      try {
          const userName = await contract.methods.getUsername(currentAccount).call();
          console.log("Username:", userName);
          document.getElementById('usernameDisplay').innerText = userName;
          document.getElementById('currentAccount').innerText += ` (${userName})`;
      } catch (error) {
          console.error("Error fetching username:", error);
      }
  }


  window.addEventListener('load', async () => {
    await loadABI();
    await initWeb3();
  });



</script>{% endblock content %}