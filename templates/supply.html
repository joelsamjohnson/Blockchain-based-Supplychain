{% extends "base user.html" %}

{% block heading %}
Supply Chain Flow:
{% endblock %}

{% block content %}
<p>Product Order -> Manufacturer -> Distributor -> Retailer -> Consumer</p>

<div id="app">
  <table class="table table-bordered">
      <thead>
      <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">Description</th>
          <th scope="col">Current Stage</th>
      </tr>
      </thead>
      <tbody id="prodTableBody">
      <!-- Products will be added here -->
      </tbody>
  </table>

  <div class="card">
    <div class="card-body" style="text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <select class="form-select" id="typeSelect" style="width: auto; flex-grow: 1;" onchange="updateButtonText()">
        <option value="Manufacturing">Manufacture</option>
        <option value="Distribute">Distribute</option>
        <option value="Retail">Retail</option>
        <option value="Sold">Sold</option>
      </select>
      <input type="text" class="form-control" id="product_id" name="prod_id" placeholder="Enter Product ID" style="flex-grow: 2;">
      <button onclick="performAction()" class="btn btn-sm btn-primary" style="flex-grow: 1;" id="submitButton">Manufacture</button>
    </div>
  </div>

  <!-- Alerts for Success and Errors -->
  <div class="alert alert-success" id="successAlert" style="display: none;"></div>
  <div class="alert alert-danger" id="errorAlert" style="display: none;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let contract, web3;
const contractAddress = '0xadA3AF5aC641504094B85CF8C0DD8410e86d06d6';

document.addEventListener('DOMContentLoaded', async () => {
    await initContracts();
    updateButtonText();
});
async function initContracts() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
            await window.ethereum.enable();  // Request access
            const accounts = await web3.eth.getAccounts();
            if (accounts.length === 0) {
                console.error("No access to accounts.");
                return;
            }
            web3.eth.defaultAccount = accounts[0];  // Set default account

            const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "DIS",
		"outputs": [
			{
				"internalType": "address",
				"name": "addr",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "place",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_productID",
				"type": "uint256"
			}
		],
		"name": "Distribute",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "MAN",
		"outputs": [
			{
				"internalType": "address",
				"name": "addr",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "place",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_productID",
				"type": "uint256"
			}
		],
		"name": "Manufacturing",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "Owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "ProductStock",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "imageHash",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "MANid",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "DISid",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "RETid",
				"type": "uint256"
			},
			{
				"internalType": "enum ProductManagement.STAGE",
				"name": "stage",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "RET",
		"outputs": [
			{
				"internalType": "address",
				"name": "addr",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "place",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_productID",
				"type": "uint256"
			}
		],
		"name": "Retail",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_address",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_place",
				"type": "string"
			}
		],
		"name": "addDistributor",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_address",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_place",
				"type": "string"
			}
		],
		"name": "addManufacturer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_price",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_imageHash",
				"type": "string"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_address",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_place",
				"type": "string"
			}
		],
		"name": "addRetailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "disCtr",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "manCtr",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "productCtr",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_productID",
				"type": "uint256"
			}
		],
		"name": "purchaseProduct",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "retCtr",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
            contract = new web3.eth.Contract(productABI, contractAddress);
            
            console.log("Contracts initialized.");
            loadProducts();
        } catch (error) {
            console.error("Error initializing contracts", error);
        }
    } else {
        console.error("Ethereum object not found. Make sure you have a web3 provider.");
    }
}


async function loadProducts() {
    if (!contract) {
        console.error("Product Management Contract is not initialized.");
        return;
    }
    const productsCount = await contract.methods.productCtr().call();
    const tableBody = document.getElementById('prodTableBody');
    for (let i = 1; i <= productsCount; i++) {
        const product = await contract.methods.ProductStock(i).call();
        const row = tableBody.insertRow();
        row.insertCell(0).innerHTML = product.id;
        row.insertCell(1).innerHTML = product.name;
        row.insertCell(2).innerHTML = product.description;
        row.insertCell(3).innerHTML = ["Product Ordered", "Manufacturing Stage", "Distribution Stage", "Retailing Stage", "Sold"][product.stage];
    }
}

function updateButtonText() {
    const select = document.getElementById('typeSelect');
    const button = document.getElementById('submitButton');
    button.textContent = select.options[select.selectedIndex].text;
}

async function performAction() {
    const productID = document.getElementById("product_id").value.trim();
    const action = document.getElementById("typeSelect").value;
    if (!productID) {
        displayAlert('errorAlert', 'Product ID is required');
        return;
    }
    try {
        const accounts = await web3.eth.getAccounts();
        if (accounts.length === 0) {
            displayAlert('errorAlert', 'No Ethereum accounts are available.');
            return;
        }
        const tx = await contract.methods[action](productID).send({ from: accounts[0] });
        displayAlert('successAlert', `Successfully performed '${action}' for Product ID ${productID}.`);
    } catch (error) {
        console.error("Error during transaction:", error);
        displayAlert('errorAlert', `Error: ${error.message}`);
    }
}

function displayAlert(alertId, message) {
    const alert = document.getElementById(alertId);
    alert.textContent = message;
    alert.style.display = 'block';
    setTimeout(() => { alert.style.display = 'none'; }, 5000);
}
</script>
{% endblock %}
