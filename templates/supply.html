{% extends "base user.html" %}

{% block heading %}
Supply Chain Flow:
{% endblock %}

{% block content %}
<p>Product Order -> Manufacturer -> Distributor -> Retailer -> Consumer</p>

<div id="app">
  <table class="table table-bordered">
      <thead>
      <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">Description</th>
          <th scope="col">Current Stage</th>
      </tr>
      </thead>
      <tbody id="prodTableBody">
      <!-- Products will be added here -->
      </tbody>
  </table>

  <div class="card">
    <div class="card-body" style="text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <select class="form-select" id="typeSelect" style="width: auto; flex-grow: 1;" onchange="updateButtonText()">
        <option value="Manufacturing">Manufacture</option>
        <option value="Distribute">Distribute</option>
        <option value="Retail">Retail</option>
        <option value="Sold">Sold</option>
      </select>
      <input type="text" class="form-control" id="product_id" name="prod_id" placeholder="Enter Product ID" style="flex-grow: 2;">
      <button onclick="performAction()" class="btn btn-sm btn-primary" style="flex-grow: 1;" id="submitButton">Manufacture</button>
    </div>
  </div>

  <!-- Alerts for Success and Errors -->
  <div class="alert alert-success" id="successAlert" style="display: none;"></div>
  <div class="alert alert-danger" id="errorAlert" style="display: none;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let productManagementContract, transactionManagementContract, web3;
const productManagementAddress = '0xE17b12feDa856174ddB941915ca5B817A9706017';
const transactionManagementAddress = '0xaf3f88ec99702f601a8ce5cb8c36253d76b2cac7';

document.addEventListener('DOMContentLoaded', async () => {
    await initContracts();
    updateButtonText();
});

async function initContracts() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
            const productABI = await (await fetch('/static/contracts/ProductManagementABI.json')).json();
            productManagementContract = new web3.eth.Contract(productABI, productManagementAddress);
            
            const transactionABI = await (await fetch('/static/contracts/TransactionManagementABI.json')).json();
            transactionManagementContract = new web3.eth.Contract(transactionABI, transactionManagementAddress);

            console.log("Contracts initialized.");
            loadProducts();
        } catch (error) {
            console.error("Error initializing contracts", error);
        }
    } else {
        console.error("Ethereum object not found. Make sure you have a web3 provider.");
    }
}

async function loadProducts() {
    if (!productManagementContract) {
        console.error("Product Management Contract is not initialized.");
        return;
    }
    const productsCount = await productManagementContract.methods.productCtr().call();
    const tableBody = document.getElementById('prodTableBody');
    for (let i = 1; i <= productsCount; i++) {
        const product = await productManagementContract.methods.ProductStock(i).call();
        const row = tableBody.insertRow();
        row.insertCell(0).innerHTML = product.id;
        row.insertCell(1).innerHTML = product.name;
        row.insertCell(2).innerHTML = product.description;
        row.insertCell(3).innerHTML = ["Product Ordered", "Manufacturing Stage", "Distribution Stage", "Retailing Stage", "Sold"][product.stage];
    }
}

function updateButtonText() {
    const select = document.getElementById('typeSelect');
    const button = document.getElementById('submitButton');
    button.textContent = select.options[select.selectedIndex].text;
}

async function performAction() {
    const productID = document.getElementById("product_id").value.trim();
    const action = document.getElementById("typeSelect").value;
    if (!productID) {
        displayAlert('errorAlert', 'Product ID is required');
        return;
    }
    try {
        const tx = await transactionManagementContract.methods[action](productID).send({ from: web3.eth.defaultAccount });
        displayAlert('successAlert', `Successfully performed '${action}' for Product ID ${productID}.`);
    } catch (error) {
        console.error("Error during transaction:", error);
        displayAlert('errorAlert', `Error: ${error.message}`);
    }
}

function displayAlert(alertId, message) {
    const alert = document.getElementById(alertId);
    alert.textContent = message;
    alert.style.display = 'block';
    setTimeout(() => { alert.style.display = 'none'; }, 5000);
}
</script>
{% endblock %}
