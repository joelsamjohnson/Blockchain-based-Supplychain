{% extends "base user.html" %}
{% block heading %}Supply Chain Flow:{% endblock heading %}
{% block content %}
<p>Product Order -&gt; Manufacturer -&gt; Distributor -&gt; Retailer -&gt; Consumer</p>

<div id="app">
  <table class="table table-bordered">
      <thead>
      <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">Description</th>
          <th scope="col">Current Stage</th>
      </tr>
      </thead>
      <tbody id="prodTableBody">
      <!-- Products will be added here -->
      </tbody>
  </table>
  <h5 class="card-title fw-semibold mb-4" id="currentAccount">Current Account Address:</h5>
      <div class="card">
        <div class="card-body" style="text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px;">
          <select class="form-select" id="typeSelect" style="width: auto; flex-grow: 1;" onchange="updateButtonText()">
            <option value="Manufacturing">Manufacture</option>
            <option value="Distribute">Distribute</option>
            <option value="Retail">Retail</option>
            <option value="Sold">Sold</option>
          </select>
          <input type="text" class="form-control" id="product_id" name="prod_id" placeholder="Enter Product ID" style="flex-grow: 2;">
          <button onclick="flow()" class="ethereumButton btn btn-sm btn-primary" style="flex-grow: 1;" id="submitButton">Submit</button>
        </div>
      </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
<br />
<div class="alert alert-success" role="alert" style="display:none;" id="successAlert">

</div>
<div class="alert alert-danger" role="alert" style="display:none;" id="errorAlert">
  Transaction was not created
</div>


<script>
  contractABI = [{
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "DIS",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "MAN",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "Owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "ProductStock",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "description",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "price",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "MANid",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "DISid",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "RETid",
          "type": "uint256"
        },
        {
          "internalType": "enum TextileSupplyChain.STAGE",
          "name": "stage",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "RET",
      "outputs": [
        {
          "internalType": "address",
          "name": "addr",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "place",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "disCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "manCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "productCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "retCtr",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addManufacturer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addDistributor",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_address",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_place",
          "type": "string"
        }
      ],
      "name": "addRetailer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Manufacturing",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Distribute",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "Retail",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "purchaseProduct",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function",
      "payable": true
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_description",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_price",
          "type": "uint256"
        }
      ],
      "name": "addproduct",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_price",
          "type": "uint256"
        }
      ],
      "name": "setProductPrice",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "isProductAvailableForPurchase",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productID",
          "type": "uint256"
        }
      ],
      "name": "showStage",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    }
  ]
const contractAddress = '0xC7A11957639a2b6f1eFe422AF0C8D6a5AbC1B263';

let currentAccount = null;
let contract;
let web3;

async function initWeb3() {
  if (window.ethereum) {
    web3 = new Web3(window.ethereum);
    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const accounts = await web3.eth.getAccounts();
      if (accounts.length > 0) {
        currentAccount = accounts[0];
        document.getElementById('currentAccount').innerText += ` ${currentAccount}`;
        contract = new web3.eth.Contract(contractABI, contractAddress);
        await renderProgressChart();
        await loadProducts(); // Make sure this function is defined and accessible
      } else {
        console.error("No accounts found.");
      }
    } catch (error) {
      console.error("Initialization error:", error);
    }
  } else {
    console.error("Please install MetaMask!");
  }
};

async function renderProgressChart() {
  const ctx = document.getElementById('productProgressChart').getContext('2d');
  const productStages = await getProductStages();
  const data = {
      labels: productStages.map(p => p.name),
      datasets: [{
          label: 'Product Progress',
          data: productStages.map(p => p.stage),
          backgroundColor: [
              'rgba(255, 99, 132, 0.2)',
              'rgba(54, 162, 235, 0.2)',
              'rgba(255, 206, 86, 0.2)',
          ],
          borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
          ],
          borderWidth: 1
      }]
  };

  const config = {
      type: 'bar',
      data: data,
      options: {
          scales: {
              y: {
                  beginAtZero: true,
                  ticks: {
                      // Assuming your stages are integers from 0 (not started) to 5 (completed)
                      stepSize: 1,
                      callback: function (value, index, values) {
                          // Customize this mapping based on your actual product stages
                          const stages = ["Not started", "Ordered", "Manufacturing", "Distributed", "Retail", "Sold"];
                          return stages[value];
                      }
                  }
              }
          }
      }
  };
  new Chart(ctx, config);
}

window.flow = async () => {
    try {
      const productID = document.getElementById("product_id").value;
      if (!productID) {
        alert("Product ID is required");
        return;
      }
      const selectValue = document.getElementById("typeSelect").value;
      let tx;
      switch (selectValue) {
        case "Manufacturing":
          tx = await contract.methods.Manufacturing(productID).send({ from: currentAccount });
          break;
        case "Distribute":
          tx = await contract.methods.Distribute(productID).send({ from: currentAccount });
          break;
        case "Retail":
          tx = await contract.methods.Retail(productID).send({ from: currentAccount });
          break;
        case "Sold":
          tx = await contract.methods.Sold(productID).send({ from: currentAccount });
          break;
        default:
          alert("Invalid selection");
          return;
      }
      if (tx) {
        const successMessage = `Successfully performed '${selectValue}' for Product ID ${productID}.`;
        const successAlert = document.getElementById('successAlert');
        successAlert.innerText = successMessage;
        successAlert.style.display = 'block';
      }
    } catch (error) {
      console.error("Error during transaction:", error);
      const errorAlert = document.getElementById('errorAlert');
      errorAlert.innerText = `Error: ${error.message}`;
      errorAlert.style.display = 'block';
    }
  };
async function loadProducts() {
  if (!contract) {
    console.error("Contract is not initialized.");
    return;
  }
  const productsCount = await contract.methods.productCtr().call();
  const tableBody = document.getElementById('prodTableBody'); // Get the tbody element where products will be added

  for (let i = 1; i <= productsCount; i++) {
      const product = await contract.methods.ProductStock(i).call();
      const row = tableBody.insertRow(); // Insert a new row in the table

      // Insert cells (`<td>`) and fill them with medicine data
      const cellId = row.insertCell(0);
      cellId.innerHTML = product.id;

      const cellName = row.insertCell(1);
      cellName.innerHTML = product.name;

      const cellDescription = row.insertCell(2);
      cellDescription.innerHTML = product.description;

      const cellStage = row.insertCell(3);
      const stageNames = [
        "Product Ordered",
        "Manufacturing Stage",
        "Distribution Stage",
        "Retailing Stage",
        "Sold"
      ];
      cellStage.innerHTML = stageNames[product.stage];
  }
}
async function main() {
  await initWeb3();
 
}
document.addEventListener('DOMContentLoaded', main);
updateButtonText();
function updateButtonText() {
    const select = document.getElementById('typeSelect');
    const button = document.getElementById('submitButton');
    const selectedText = select.options[select.selectedIndex].text; // Get the text of the selected option
    button.textContent = selectedText; // Update the button text
}
async function getProductStages() {
    const productsCount = await contract.methods.productCtr().call();
    let productStages = []; // Initialize an empty array to hold product stages

    for (let i = 1; i <= productsCount; i++) {
        const product = await contract.methods.ProductStock(i).call();

        // Add an object with the product name and stage to the productStages array
        productStages.push({
            name: product.name,
            stage: parseInt(product.stage) // Ensure stage is treated as an integer
        });
    }
    return productStages;
}
</script>
{% endblock content %}


{% block something %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="chart-container" style="position: relative; height:40vh; width:80vw">
    <canvas id="productProgressChart"></canvas>
</div>
{% endblock something %}
