{% extends 'base.html' %}
{% block heading %}Add Product Order{% endblock heading %}
{% block content %}
      <div class="card">
        <div class="card-body">
          <form id="productForm" method="post" action="{% url 'add_product' %}" class="product-form">
            {% csrf_token %}
            <div class="mb-3">
              <label for="currentAccount" class="form-label"><b>Current Account Address:</b></label>
              <span id="currentAccount"></span>
            </div>
            <div class="mb-3">
              <label for="id_name" class="form-label">Name</label>
              <input type="text" class="form-control" id="id_name" name="name" maxlength="100" required>
            </div>
            <div class="mb-3">
              <label for="id_description" class="form-label">Description</label>
              <textarea class="form-control" id="id_description" name="description" maxlength="500" required></textarea>
              <div id="descriptionHelp" class="form-text">Provide a brief description of the product.</div>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
        </div>
      </div>

<div id="app">
    <h5>Ordered Products:</h5>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Name</th>
                <th scope="col">Description</th>
                <th scope="col">Current Stage</th>
            </tr>
        </thead>
        <tbody id="prodTableBody">
            <!-- Products will be added here -->
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>

<script>
  async function loadABI() {
      const response = await fetch('./contracts/myContractABI.json');
      const abi = await response.json();
  }

  let contract;
  const web3 = new Web3(window.ethereum);
  const form = document.getElementById('addProductForm');
  let currentAccount = null;
  const prodTableBody = document.getElementById('prodTableBody');

  async function initWeb3() {
  if (window.ethereum) {
      window.web3 = new Web3(window.ethereum);
      console.log("Web3 initialized.");
      try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          console.log("Accounts requested.");
          const accounts = await web3.eth.getAccounts();
          console.log("Accounts retrieved:", accounts);
          if (accounts.length > 0) {
              currentAccount = accounts[0];
              console.log("Current Account:", currentAccount);
              document.getElementById('currentAccount').innerText = `${currentAccount}`;
              contract = new web3.eth.Contract(contractABI, '0xFE8dd0108F2120998b31F236F1435D090C1f3d1c');
              console.log("Contract initialized:", contract);
          } else {
              console.error("No accounts found.");
          }
      } catch (error) {
          console.error("Could not get accounts", error);
      }
  } else {
      console.error("Ethereum object not found. Make sure you have a web3 provider.");
  }
}


  document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('id_name').value;
      const description = document.getElementById('id_description').value;
      try {
          await contract.methods['addproduct'](name, description).send({ from: currentAccount });
          console.log('Product added successfully');
      } catch (error) {
          console.error('Failed to add product', error);
      }

  });
  async function loadProducts() {
      const productsCount = await contract.methods.productCtr().call();
      const tableBody = document.getElementById('prodTableBody'); // Get the tbody element where products will be added

      for (let i = 1; i <= productsCount; i++) {
          const product = await contract.methods.ProductStock(i).call();
          const row = tableBody.insertRow(); // Insert a new row in the table

          // Insert cells (`<td>`) and fill them with medicine data
          const cellId = row.insertCell(0);
          cellId.innerHTML = product.id;

          const cellName = row.insertCell(1);
          cellName.innerHTML = product.name;

          const cellDescription = row.insertCell(2);
          cellDescription.innerHTML = product.description;

          const cellStage = row.insertCell(3);
          const stageNames = [
            "Product Ordered",
            "Raw Material Supply Stage",
            "Manufacturing Stage",
            "Distribution Stage",
            "Retailing Stage",
            "Sold"
          ];
          cellStage.innerHTML = stageNames[product.stage]; 
      }
  }

  window.addEventListener('load', async () => {
    await loadABI();
    await initWeb3();
    await loadProducts();
  });


// Add more functions to interact with your contract as needed

</script>{% endblock content %}