{% extends 'base.html' %}
{% load static %}
{% block heading %}View Product Details{% endblock %}

{% block content %}
<style>
	.product-image-container {
		width: 30%;
		/* Adjust this value as needed */
		margin: auto;
		/* This centers the container horizontally */
	}

	.product-image {
		max-width: 100%;
		height: auto;
		max-height: 300px;
		/* Adjust max height as needed */
	}
</style>
<div class="row">
	<!-- Product image and details -->
	<div class="col-md-12">
		<div class="card overflow-hidden rounded-2">
			<!-- Product image container -->
			<div class="product-image-container">
				<img id="productImage" src="{% static 'images/product-placeholder2.jpg' %}" alt="Product Image"
					class="card-img-top img-fluid product-image">
			</div>
			<!-- Product details -->
			<div class="card-body" id="productDetails">
				<!-- Product details columns -->
				<div class="row">
					<div class="col-md-6">
						<h6 class="fw-semibold" id="productName">Awaiting Product Name...</h6>
						<p id="productDescription">Retrieving description...</p>
						<p id="productPrice">Fetching price information...</p>
					</div>
					<div class="col-md-6">
						<p id="manufacturerDetails">Manufacturer details are being gathered...</p>
						<p id="distributorDetails">Obtaining distributor information...</p>
						<p id="retailerDetails">Retrieving retailer data...</p>
					</div>
				</div>
				<!-- Processing stage -->
				<div class="row">
					<div class="col-12">
						<b id="processingStage">Determining current processing stage...</b>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- Column for the product ID form -->
<div class="col-md-12">
	<form action="#" method="GET" id="productIDForm" class="mt-3">
		<label for="productIDInput">Enter Product ID:</label>
		<input type="number" class="form-control" id="productIDInput" name="productID" required><br>
		<button type="submit" class="btn btn-primary" id="viewProductButton">View Product</button>
	</form>
</div>


<!-- Error alert -->
<div class="alert alert-danger" role="alert" style="display:none;" id="errorAlert"></div>


<script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>

<script>
contractABI =[
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "DIS",
    "outputs": [
      {
        "internalType": "address",
        "name": "addr",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "place",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "MAN",
    "outputs": [
      {
        "internalType": "address",
        "name": "addr",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "place",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [],
    "name": "Owner",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "ProductStock",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "description",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "price",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "imageHash",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "MANid",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "DISid",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "RETid",
        "type": "uint256"
      },
      {
        "internalType": "enum ProductManagement.STAGE",
        "name": "stage",
        "type": "uint8"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "ProductsByAddress",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "RET",
    "outputs": [
      {
        "internalType": "address",
        "name": "addr",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "place",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_address",
        "type": "address"
      },
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_place",
        "type": "string"
      }
    ],
    "name": "addDistributor",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_address",
        "type": "address"
      },
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_place",
        "type": "string"
      }
    ],
    "name": "addManufacturer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_description",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_price",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "_imageHash",
        "type": "string"
      }
    ],
    "name": "addProduct",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_address",
        "type": "address"
      },
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_place",
        "type": "string"
      }
    ],
    "name": "addRetailer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "disCtr",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [],
    "name": "manCtr",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [],
    "name": "productCtr",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "purchases",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [],
    "name": "retCtr",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_productID",
        "type": "uint256"
      }
    ],
    "name": "Manufacturing",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_productID",
        "type": "uint256"
      }
    ],
    "name": "Distribute",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_productID",
        "type": "uint256"
      }
    ],
    "name": "Retail",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_productID",
        "type": "uint256"
      }
    ],
    "name": "purchaseProduct",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function",
    "payable": true
  }
]
const web3 = new Web3(window.ethereum);
const contractAddress = '0xF4017D3269A1889049434f895BBB73aa642E8823';
const contract = new web3.eth.Contract(contractABI, contractAddress);
// Function to display error alert
function displayErrorAlert(message) {
	const errorAlert = document.getElementById('errorAlert');
	errorAlert.textContent = message;
	errorAlert.style.display = 'block';
}

// Function to hide error alert
function hideErrorAlert() {
	document.getElementById('errorAlert').style.display = 'none';
}

// Function to fetch and display product details
async function showProductDetails() {
	const productID = document.getElementById("productIDInput").value;

	fetch(`/show-product-details/${productID}/`)
		.then(response => {
			if (!response.ok) {
				throw new Error("Product not found");
			}
			return response.json();
		})
		.then(message => {
			if (message.error) {
				throw new Error(message.error); // Throw an error if the response contains an error message
			}
			document.getElementById('productName').innerHTML = `Name: ${data.product_name}`;
			document.getElementById('productDescription').innerHTML = `Description: ${data.product_description}`;
			document.getElementById('productPrice').innerHTML = `Price: ${data.product_price} wei`;
			document.getElementById('manufacturerDetails').innerHTML = `Manufacturer Name: ${data.MANname} <br> Place: ${data.MANplace}`;
			document.getElementById('distributorDetails').innerHTML = `Distributor Name: ${data.DISname} <br> Place: ${data.DISplace}`;
			document.getElementById('retailerDetails').innerHTML = `Retailer Name: ${data.RETname} <br> Place: ${data.RETplace}`;
			document.getElementById('processingStage').innerHTML = data.processing_stage;
			document.getElementById('productImage').src = data.product_image_url;  // Update image source
		})
		.catch(error => {
			console.error('Error fetching product details:', error);
			// Display error alert
			document.getElementById('errorAlert').innerHTML = 'Product ID does not exist';
			document.getElementById('errorAlert').style.display = 'block'; // Show error alert
			// Clear product details
			document.getElementById('productName').innerHTML = "Name: Not Available";
			document.getElementById('productDescription').innerHTML = "Description: Not Available";
			document.getElementById('productPrice').innerHTML = "Price: Not Available";
			document.getElementById('manufacturerDetails').innerHTML = "Manufacturer: Not Available";
			document.getElementById('distributorDetails').innerHTML = "Distributor: Not Available";
			document.getElementById('retailerDetails').innerHTML = "Retailer: Not Available";
			document.getElementById('processingStage').innerHTML = "Processing Stage: Not Available";
			document.getElementById('productImage').src = "{% static 'images/product-placeholder2.jpg' %}";
		});
}


// Event listener for form submission
document.getElementById('productIDForm').addEventListener('submit', function (event) {
	event.preventDefault();
	showProductDetails();
});


</script>

{% endblock %}

<div class="py-6 px-6 text-center">
	<p class="mb-0 fs-4">Design and Developed by <a href="https://adminmart.com/" target="_blank"
			class="pe-1 text-primary text-decoration-underline">AdminMart.com</a> Distributed by <a
			href="https://themewagon.com">ThemeWagon</a></p>
</div>